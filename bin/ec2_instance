#!/usr/bin/env bash

if [ -f "../.env" ]
then
  source "../.env"
fi

arg=$1

if [ "$arg" == 'status' ] # check instance status
then
	aws ec2 describe-instance-status --instance-ids "$OSRS_EC2_ID"
elif [ "$arg" == 'start' ] # start instance
then
	aws ec2 start-instances --instance-ids "$OSRS_EC2_ID"
elif [ "$arg" == 'stop' ] # stop instance
then
	aws ec2 stop-instances --instance-ids "$OSRS_EC2_ID"
elif [ "$arg" == 'connect' ] # connect to instance through SSH
then
	ip_addr=$(aws ec2 describe-instances --instance-id "$OSRS_EC2_ID" \
	          | jq -r '.Reservations[0].Instances[0].PublicIpAddress')
	ssh -i "$HOME/.aws/$OSRS_EC2_PEM" "ec2-user@$ip_addr"
elif [ "$arg" == 'setup' ] # run once to install dependencies and setup Docker
then
	sudo yum upgrade -y
	sudo yum install git -y
	sudo yum install docker -y
	sudo groupadd docker
	sudo usermod -aG docker
elif [ "$arg" == 'dockerd' ] # run to start Docker daemon
then
  sudo service docker start
else
  echo "usage: ./ec2_instance [status|start|stop|connect|setup|dockerd]"
  exit 1
fi
