#!/usr/bin/env bash
VPN_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &> /dev/null && pwd)/../ref/vpn"
cd "$VPN_DIR" && echo "resetting vpn..."

sudo -Sv || exit 1 # request sudo if we don't have it

restart () {
  sudo pkill openvpn >/dev/null 2>&1 ; sleep 1
  ./mkserver && \
  sudo openvpn --config tmpserver.ovpn --auth-user-pass ~/.openvpn --writepid openvpn.pid --daemon
  sleep 2 && echo -n "setting up tunnel... " && sleep 3
  ps -p $(cat openvpn.pid) >/dev/null 2>&1
}

until restart; do echo "setup failed, retrying"; done
echo "done"

echo "connecting to www.jagex.com..."
until ping -c 1 "www.jagex.com" >/dev/null 2>&1; do :; done
echo "connected via $(curl -s ifconfig.me)"
